---
title: 自定义多功能的表情输入键盘
grammar_cjkRuby: true
---

# 简介
自定义的表情输入键盘在很多应用中都会有用到，譬如微信、QQ 等社交聊天软件中更是不可缺少的部分。本文将解析一下个人的自定义表情输入控件库 PandaEmoView 的实现和使用。
### 该库具有以下特点：
- 支持 emoji 表情图片
- 支持 gif 动态表情输入显示
- 支持单张贴图表情（与微信收藏表情一致）
- 支持题图表情库的添加删除
### 效果图：

# 快速使用
# 主要使用类方法概览
## PandaEmoEditText 
- 表情输入框继承自 `EditText` 只对 `onKeyIme()` 进行复写用于监听输入键盘或者软键盘的弹出与关闭

## PandaEmoView
- 表情输入控件 View 继承自 `RelativeLayout`

| 方法 | 返回值 | 参数  | 描述 | 
| :-- | :-- | :-- |   :--    |
|   attachEditText(PandaEmoEditText input)   |    void    |  表情输入控件（如使用自定义 EditText 可直接继承重写）   |  绑定输入控件   |
|   getAttachEditText()   |    void    |     |   获取当前表情控件绑定的输入框控件  |
|   reloadEmos   |    void    |  position 重载表情控件数据后默认选中 Tab 的 position   |  添加或者删除表情数据后重载刷新表情控件   |

## PandaEmoManager
- `PandaEmoManager` 为核心配置类，表情控件的各种参数都通过此类的构造器进行配置

| 属性 | 类型 | 描述 |默认值|
| :--  |:--    |:--  |:--  |
|   EMOT_DIR   |    String   | 默认表情图在 assets 中的路径 (assets 目录到配置 xml 文件之间的部分的路径，demo 中的 face)|face|
|   SOURCE_DIR   |   String    |  EMOT_DIR 目录下存放图片资源的文件夹路径 （demo 中的 images）|source_default|
|   STICKER_PATH   |    String   | Sticker贴图包的存放目录，该目录下的每一个文件目录都为一个贴图包|   /data/data/< package name>/files/sticker   |
|   CACHE_MAX_SIZE   |   int    |  加载表情 LruCache 缓存大小  | 1024 |
|   DEFAULT_EMO_BOUNDS_DP   |   int    |   表情图显示大小（非贴图表情）   |   30dp   |
|   defaultIcon   |   int    |    表情 Tab 资源文件名  |   R.drawable.ic_default   |
|   mContext  |   Context    |   上下文   |   null   |
|   mConfigFile   |    String   |   EMOT_DIR 目录下的 emoji 配置文件名称   |   emoji_default.xml   |
|   mIImageLoader   |   IImageLoader    |  Sticker 图片加载器接口，加载方式外部传入   |  null    |
|   MAX_CUSTOM_STICKER   |    int   |  最大添加的自定义贴图表情数    |  30    |
|   EMOJI_ROW   |   int     |   emoji 表情单页行数  |   3  |
|   EMOJI_COLUMN   |  int      |  emoji 表情单页列数   |  7   |
|   STICKER_ROW   |    int    |  sticker 表情单页行数   |  2   |
|   STICKER_COLUMN   | int       |  sticker 表情单页列数   |  4   |
|   showAddButton   |     boolean   |  tab 栏是否显示添加按钮   |   ture  |
|   showSetButton   |   boolean     |   tab 栏是否显示设置按钮  |ture|
|   showStickers   |   boolean     |  tab 栏是否显示贴图按钮（所以 sticker）   |  ture   |

| 方法 | 返回值 | 参数  | 描述 | 
| :-- | :-- | :-- |   :--    |
|   init（）   |   void     |  无参   |  初始化 拼接 Sticker 路径及创建自定义贴图 文件夹 (STICKER_PATH + "/selfSticker" ) |
|   makePattern()   |    Pattern    |   无参  |  创建 emoji 正则匹配器  |
`剩余方法都为属性值的 getter() setter() 不在赘述。`
## PandaEmoManager.Builder
- `PandaEmoManager` 的构造器类，属性及方法都与 PandaEmoManager 一一对应；

## KeyBoardManager
- `KeyBoardManager` 为输入法软键盘与表情输入控件协调管理类
 
| 属性 | 类型 | 描述 | 默认值 |
| :-- | :-- | :-- |   :--    |
|   SHARE_PREFERENCE_NAME   |    String    |   用于存储键盘高度的 SP 的名字  |  "EmotionKeyBoard"   |
|    SHARE_PREFERENCE_SOFT_INPUT_HEIGHT  |   String     |  用于存储键盘高度的 key   |  "EmotionKeyBoard" |
|    mActivity  |    Activity    |  控件依附的 Activity 界面   |  null   |
|    mEmotionView  |   PandaEmoView   |   当前管理的表情输入控件  |  null   |
|    interceptBackPress  |    boolean    |  是否拦截返回键   |  false   |
|    lockView  |    View    |  锁定高度的 View（即同一线性父布局中，表情控件之外的布局视图）   |   null  |
|    mOnEmotionButtonOnClickListener  |    OnEmotionButtonOnClickListener    |  表情显示控制按钮监听   |  null   |
|    mOnInputShowListener  |     OnInputShowListener   |   监听输入栏的弹出与关闭  |  null   |

| 方法 | 返回值 | 参数  | 描述 | 
| :------  | :--    | :-- |   :--    |
|   with()  |   KeyBoardManager     |   Activity : 当前输入控件依附的 Activity  |   初始化 KeyBoardManager 创建单例 |
|   bindToLockContent()   |    KeyBoardManager    |  lockView:切换需要锁定高度的 View    |  赋值给内部属性 lockView   |
|   bindToEmotionButton()    |    KeyBoardManager    |   View...: 多个 View 参数，切换控制按钮  |  为输入控件绑定控制按钮   |
|   setEmotionView()   |    KeyBoardManager    | PandaEmoView: 被管理的表情控件  | 绑定当前管理的输入控件（绑定的控件必须在此之前调用 PandaEmoView.attachEditText() 否则内部将会空指针）  |
|   interceptBackPress()         |    boolean    |   null  |  在 Activity 的 backPressd()  中检查是否需要拦截返回键关闭输入栏而不是退出界面  |
|  hideInputLayout()     | void|null | 供外部调用关闭输入栏（不能未初始化直接调用） |
|  showInputLayout()   | void|null | 供外部调用显示输入栏（不能未初始化直接调用） |
## EmoticonManager
- `EmoticonManager` 为 emoji 表情加载管理类，此类提供方法将资源文件根据配置文件加载进内存

| 属性 | 返回值 | 参数  | 描述 | 
| :-- | :-- | :-- |   :--    |
|      |        |     |     |
|    **啊**  |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |

## StickerManager
- `StickerManager` 为 sticker 表情加载管理类，此类提供方法将资源文件根据配置文件加载进内存

| 属性 | 返回值 | 参数  | 描述 | 
| :-- | :-- | :-- |   :--    |
|      |        |     |     |
|    **啊**  |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
## PandaEmoTranslator
- `PandaEmoTranslator` 为 emoji 表情  [文字] 转表情的转换工具类

| 属性 | 返回值 | 参数  | 描述 | 
| :-- | :-- | :-- |   :--    |
|      |        |     |     |
|    **啊**  |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
|      |        |     |     |
# 简单分析
## emoji 表情及动态表情
## 贴图表情